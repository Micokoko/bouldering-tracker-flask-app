{% extends 'base.html' %}

{% block content %}
<section class="content">
    <header>
        <h1>Welcome, {{ g.user['username'] }}</h1>
    </header>
    
    <h1>All Boulders</h1>

    {% if boulders %}
        <table class="table table-striped table-bordered" id="boulderTable">
            <thead>
                <tr>
                    <th class="text-center" data-column="name">
                        <a href="#" onclick="sortTable('name')">Name</a>
                    </th>
                    <th class="text-center" data-column="color">
                        <a href="#" onclick="sortTable('color')">Color of Holds</a>
                    </th>
                    <th class="text-center" data-column="difficulty">
                        <a href="#" onclick="sortTable('difficulty')">Difficulty</a>
                    </th>
                    <th class="text-center" data-column="numberofmoves">
                        <a href="#" onclick="sortTable('numberofmoves')">Number of Moves</a>
                    </th>
                    <th class="text-center" data-column="number_of_attempts">
                        <a href="#" onclick="sortTable('number_of_attempts')">Attempts</a>
                    </th>
                    <th class="text-center" data-column="status">
                        <a href="#" onclick="sortTable('status')">Status</a>
                    </th>
                    <th class="text-center" data-column="attempt_date">
                        <a href="#" onclick="sortTable('attempt_date')">Attempt Date</a>
                    </th>
                    <th class="text-center">Log Ascent</th>
                </tr>
            </thead>
            <tbody>
                {% for boulder in boulders %}
                <tr>
                    <td>{{ boulder.name }}</td>
                    <td style="background-color: {{ boulder.color }};"></td>
                    <td>V{{ boulder.difficulty }}</td>
                    <td>{{ boulder.numberofmoves }}</td>
                    
                    {% set attempts_for_boulder = [] %}
                    {% for attempt in attempts %}
                        {% if attempt.boulder_id == boulder.id %}
                            {% set attempts_for_boulder = attempts_for_boulder.append(attempt) %}
                        {% endif %}
                    {% endfor %}

                    {% if attempts_for_boulder %}
                        {% set attempt = attempts_for_boulder[0] %}
                        <td>{{ attempt.number_of_attempts }}</td>
                        <td>
                            {% if attempt.status == 'flashed' %}
                                Flashed
                            {% elif attempt.status == 'completed' %}
                                Completed all {{ boulder.numberofmoves }} moves
                            {% elif attempt.status == 'incomplete' %}
                                Completed {{ attempt.moves_completed }} of {{ boulder.numberofmoves }} moves
                            {% endif %}
                        </td>
                        <td>{{ attempt.attempt_date }}</td>
                    {% else %}
                        <td>0</td>
                        <td>No log record yet</td>
                        <td>N/A</td>
                    {% endif %}
                    
                    <td><a class="btn btn-warning" href="{{ url_for('log_ascent.log_ascent_user', id=boulder.id) }}">Log</a></td>
                </tr>
                {% endfor %}
            </tbody>            
        </table>
    {% else %}
        <p>No boulders found.</p>
    {% endif %}

    <a href="{{ url_for('auth.logout') }}" class="btn btn-secondary">Log Out</a>
</section>

<script>
    let sortOrder = {};

    function sortTable(column) {
        const table = document.getElementById('boulderTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const columnIndex = Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.column === column);
        const isAscending = sortOrder[column] === 'asc' ? true : false;

        const sortedRows = rows.sort((rowA, rowB) => {
            const cellA = rowA.children[columnIndex].textContent.trim();
            const cellB = rowB.children[columnIndex].textContent.trim();

            if (column === 'attempt_date') {
                const dateA = new Date(cellA);
                const dateB = new Date(cellB);
                return isAscending ? dateA - dateB : dateB - dateA;
            }

            if (column === 'status') {
                const statusOrder = { 'flashed': 1, 'completed': 2, 'incomplete': 3 };
                const statusA = statusOrder[cellA.toLowerCase()] || 4;
                const statusB = statusOrder[cellB.toLowerCase()] || 4;

                // For 'incomplete', sort by the percentage of moves completed
                if (statusA === 3 && statusB === 3) {
                    const movesCompletedA = parseInt(rowA.children[6].textContent.split(' ')[1] || 0, 10);
                    const movesCompletedB = parseInt(rowB.children[6].textContent.split(' ')[1] || 0, 10);
                    const totalMovesA = parseInt(rowA.children[4].textContent, 10);
                    const totalMovesB = parseInt(rowB.children[4].textContent, 10);
                    const percentA = (movesCompletedA / totalMovesA) * 100;
                    const percentB = (movesCompletedB / totalMovesB) * 100;
                    return isAscending ? percentA - percentB : percentB - percentA;
                }

                return isAscending ? statusA - statusB : statusB - statusA;
            }

            if (column === 'difficulty') {
                const difficultyA = parseInt(cellA.replace(/^V/, ''), 10);
                const difficultyB = parseInt(cellB.replace(/^V/, ''), 10);
                return isAscending ? difficultyA - difficultyB : difficultyB - difficultyA;
            }

            if (!isNaN(cellA) && !isNaN(cellB)) {
                return isAscending ? Number(cellA) - Number(cellB) : Number(cellB) - Number(cellA);
            }

            return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });

        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));

        // Toggle sort order
        sortOrder[column] = isAscending ? 'desc' : 'asc';
    }
</script>

{% endblock %}
