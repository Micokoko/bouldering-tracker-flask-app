{% extends 'base.html' %}

{% block content %}
<section class="content">
    <header>
        <h1>Welcome, {{ g.user['username'] }}</h1>
    </header>

    <div class="card" style="background-color:#31363F;">
        <div>
            <h3>Highest grade climbed: v{{ highest_grade_climbed }}</h3>
            <h3>Highest grade flashed: v{{ highest_grade_flashed }}</h3>
            <h3>Total number of boulders completed: {{ boulders_completed }}</h3>
        </div>
    </div>
    
    <h1>All Boulders</h1>

    {% if boulders %}
        <table class="table table-striped table-bordered" id="boulderTable" style="background-color: #76ABAE;">
            <thead>
                <tr>
                    <th class="text-center" data-column="name">
                        <a href="#" onclick="sortTable('name')">Name</a>
                    </th>
                    <th class="text-center" data-column="color">
                        <a href="#" onclick="sortTable('color')">Color of Holds</a>
                    </th>
                    <th class="text-center" data-column="difficulty">
                        <a href="#" onclick="sortTable('difficulty')">Difficulty</a>
                    </th>
                    <th class="text-center" data-column="numberofmoves">
                        <a href="#" onclick="sortTable('numberofmoves')">Number of Moves</a>
                    </th>
                    <th class="text-center" data-column="number_of_attempts">
                        <a href="#" onclick="sortTable('number_of_attempts')">Attempts</a>
                    </th>
                    <th class="text-center" data-column="status">
                        <a href="#" onclick="sortTable('status')">Status</a>
                    </th>
                    <th class="text-center" data-column="attempt_date">
                        <a href="#" onclick="sortTable('attempt_date')">Attempt Date</a>
                    </th>
                    <th class="text-center">Log Ascent</th>
                </tr>
            </thead>
            <tbody>
                {% for boulder in boulders %}
                <tr>
                    <td class="text-center align-middle">{{ boulder.name }}</td>
                    <td class="align-middle">
                        <div class="card" style="background-color: {{ boulder.color }}; width: 30px; height: 30px; border-radius: 50%;"></div>
                    </td>
                    <td class="text-center align-middle">V{{ boulder.difficulty }}</td>
                    <td class="text-center align-middle total-moves">{{ boulder.numberofmoves }}</td>
            
                    {% set attempts_for_boulder = [] %}
                    {% for attempt in attempts %}
                        {% if attempt.boulder_id == boulder.id %}
                            {% set attempts_for_boulder = attempts_for_boulder.append(attempt) %}
                        {% endif %}
                    {% endfor %}
            
                    {% if attempts_for_boulder %}
                        {% set attempt = attempts_for_boulder[0] %}
                        <td class="text-center align-middle attempts">{{ attempt.number_of_attempts }}</td>
                        <td class="text-center align-middle status">
                            {% if attempt.status == 'flashed' %}
                                Flashed
                            {% elif attempt.status == 'completed' %}
                                Completed
                            {% elif attempt.status == 'incomplete' %}
                                Incomplete ({{ attempt.moves_completed }} / {{ boulder.numberofmoves }} moves)
                            {% endif %}
                        </td>
                        <td class="text-center align-middle">{{ attempt.attempt_date }}</td>
                    {% else %}
                        <td class="text-center align-middle attempts">0</td>
                        <td class="text-center align-middle status">No log record yet</td>
                        <td class="text-center align-middle">N/A</td>
                    {% endif %}
                    
                    <td class="text-center align-middle"><a class="btn btn-warning" href="{{ url_for('log_ascent.log_ascent_user', id=boulder.id) }}">Log</a></td>
                </tr>
                {% endfor %}
            </tbody>            
        </table>
    {% else %}
        <p>No boulders found.</p>
    {% endif %}

    <a href="{{ url_for('auth.logout') }}" class="btn btn-secondary">Log Out</a>
</section>

<script>
    let sortOrder = {};

    function sortTable(column) {
        const table = document.getElementById('boulderTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const columnIndex = Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.column === column);
        const isAscending = sortOrder[column] === 'asc' ? true : false;

        const sortedRows = rows.sort((rowA, rowB) => {
            const cellA = rowA.children[columnIndex].textContent.trim();
            const cellB = rowB.children[columnIndex].textContent.trim();

            if (column === 'status') {
                const statusOrder = { 'flashed': 1, 'completed': 2, 'incomplete': 3 };
                const statusA = statusOrder[cellA.toLowerCase().split(' ')[0]] || 4;
                const statusB = statusOrder[cellB.toLowerCase().split(' ')[0]] || 4;

                if (statusA === 3 && statusB === 3) {
                    const movesCompletedA = parseInt(rowA.querySelector('.status').textContent.match(/\d+/g)[0] || 0, 10);
                    const totalMovesA = parseInt(rowA.querySelector('.total-moves').textContent, 10);
                    const movesCompletedB = parseInt(rowB.querySelector('.status').textContent.match(/\d+/g)[0] || 0, 10);
                    const totalMovesB = parseInt(rowB.querySelector('.total-moves').textContent, 10);

                    const percentA = (movesCompletedA / totalMovesA) * 100;
                    const percentB = (movesCompletedB / totalMovesB) * 100;

                    if (percentA !== percentB) {
                        return isAscending ? percentB - percentA : percentA - percentB;
                    }

                    const attemptsA = parseInt(rowA.querySelector('.attempts').textContent, 10);
                    const attemptsB = parseInt(rowB.querySelector('.attempts').textContent, 10);
                    return isAscending ? attemptsA - attemptsB : attemptsB - attemptsA;
                }

                if (statusA === 2 && statusB === 2) {
                    const attemptsA = parseInt(rowA.querySelector('.attempts').textContent, 10);
                    const attemptsB = parseInt(rowB.querySelector('.attempts').textContent, 10);
                    return isAscending ? attemptsA - attemptsB : attemptsB - attemptsA;
                }

                return isAscending ? statusA - statusB : statusB - statusA;
            }

            if (column === 'attempt_date') {
                const dateA = new Date(cellA);
                const dateB = new Date(cellB);
                return isAscending ? dateA - dateB : dateB - dateA;
            }

            if (column === 'difficulty') {
                const difficultyA = parseInt(cellA.replace(/^V/, ''), 10);
                const difficultyB = parseInt(cellB.replace(/^V/, ''), 10);
                return isAscending ? difficultyA - difficultyB : difficultyB - difficultyA;
            }

            if (!isNaN(cellA) && !isNaN(cellB)) {
                return isAscending ? Number(cellA) - Number(cellB) : Number(cellB) - Number(cellA);
            }

            return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });

        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));

        sortOrder[column] = isAscending ? 'desc' : 'asc';
    }
    

    function colorRows() {
        const rows = document.querySelectorAll('#boulderTable tbody tr');
        rows.forEach(row => {
            const attemptsCell = row.querySelector('.attempts');
            const statusCell = row.querySelector('.status');
            
            if (attemptsCell && statusCell) {
                const attempts = parseInt(attemptsCell.textContent.trim(), 10);
                let status = statusCell.textContent.trim().toLowerCase();
    
                if (status.includes('completed')) {
                    status = 'completed';
                } else if (status.includes('flashed')) {
                    status = 'flashed';
                } else if (status.includes('incomplete')) {
                    status = 'incomplete';
                } else {
                    status = 'no log record yet';
                }
    
                if (status === 'incomplete') {
                    row.style.backgroundColor = '#FFF200'; // Bright yellow for incomplete
                } else if (status === 'completed') {
                    if (attempts === 1) {
                        row.style.backgroundColor = '#8eff00'; // Light greenish yellow
                    } else if (attempts === 2) {
                        row.style.backgroundColor = '#99ff00'; // Slightly darker greenish yellow
                    } else if (attempts === 3) {
                        row.style.backgroundColor = '#a3ff00'; // More yellow-green
                    } else if (attempts === 4) {
                        row.style.backgroundColor = '#adff00'; // Yellow-green
                    } else if (attempts === 5) {
                        row.style.backgroundColor = '#b7ff00'; // Brighter yellow-green
                    } else if (attempts === 6) {
                        row.style.backgroundColor = '#c2ff00'; // More yellow
                    } else if (attempts === 7) {
                        row.style.backgroundColor = '#c7ff33'; // Slightly lighter yellow
                    } else if (attempts >= 8) {
                        row.style.backgroundColor = '#cfff66'; // Bright yellow-green
                    }
                } else if (status === 'flashed') {
                    row.style.backgroundColor = '#43A9D9'; // Light blue-green for flashed
                }
            }
        });
    }
    

    document.addEventListener('DOMContentLoaded', colorRows);
</script>
{% endblock %}
